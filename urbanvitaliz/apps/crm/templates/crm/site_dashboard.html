{% extends "base.html" %}

{% load sass_tags %}
{% load static %}
{% load activity_tags %}
{% load humanize %}
{% load gravatar %}
{% load django_vite %}
{% load guardian_tags %}
{% load projects_extra %}


{% get_obj_perms request.user for request.site as "user_site_perms" %}
{% is_staff_for_current_site request.user as is_staff %}


{% block js %}

{% vite_asset 'js/apps/crm.js' %}


{% endblock %}

{% block title %}
| Tableau de bord
{% endblock %}

{% block content %}

<div x-data="Crm" class="d-flex px-0" style="font-family: 'Marianne', arial, sans-serif;">

    {% include "crm/fragments/sidebar.html" with search=True back_button=True map=True tools=True %}

    <div class="w-75 d-flex flex-column justify-content-start">
        {% if active_project %}
            <div class="crm-header px-4 py-3 pt-4 mb-3">
        {% else %}
            <div class="crm-header no-project px-4 py-3 pt-4">
        {% endif %}
            <h3 class="d-flex align-items-center">
                <span class="fs-3">
                    <img
                        src="{% gravatar_url user.email 40 %}"
                        alt="{{ user.get_full_name }}"
                        class="me-2 rounded-circle align-middle"
                        style="width: 40px; height: 40px;"
                    />
                    <span class="align-middle">Salut, {{ request.user.first_name|default:request.user.username }} !</span>
                </span>
            </h3>
            <span class="fs-5 text-secondary">Bienvenue dans l'interface de gestion du portail {{ request.site.name }}</span>

            </div>

            <div class="">
                                    <li class="dropdown-item border-0 d-inline-block position-relative">
                        <svg class="bi me-2 d-inline" width="16" height="16">
                            <use xlink:href="{% static 'svg/bootstrap-icons.svg' %}#person-circle"/>
                        </svg>
                        <a href="{% url 'crm-user-list' %}">Utilisateur·trice·s</a>
                    </li>
                    <li class="dropdown-item border-0 d-inline-block position-relative">
                        <svg class="bi me-2 d-inline" width="16" height="16">
                            <use xlink:href="{% static 'svg/bootstrap-icons.svg' %}#folder-fill"/>
                        </svg>
                        <a href="{% url 'crm-project-list' %}">Projets</a>
                    </li>
                    {% if is_staff %}
                    <li class="dropdown-item border-0 d-inline-block position-relative">
                        <svg class="bi me-2 d-inline" width="16" height="16">
                            <use xlink:href="{% static 'svg/bootstrap-icons.svg' %}#signpost-fill"/>
                        </svg>
                        <a href="{% url 'projects-task-recommendation-list' %}">Pré-fléchage</a>
                    </li>
                    {% endif %}
                    {% if request.site.configuration.project_survey and "manage_surveys" in user_site_perms %}
                    <li class="dropdown-item border-0 d-inline-block position-relative">
                        <svg class="bi me-2 d-inline" width="16" height="16">
                            <use xlink:href="{% static 'svg/bootstrap-icons.svg' %}#question-circle"/>
                        </svg>
                        <a href="{% url 'survey-editor-survey-details' request.site.configuration.project_survey_id %}">Questionnaire</a>
                    </li>
                    {% endif %}


                <div class="pt-3 px-4 crm-border-bottom pb-4">
                    <h5 class="d-inline-block relative">
                        <svg class="bi align-middle" width="24" height="24">
                            <use xlink:href="{% static 'svg/bootstrap-icons.svg' %}#tools"/>
                        </svg>
                        <span>Boite à outils</span>
                    </h5>
                    <ul class="list">
                        <li><a href="{% url 'crm-project-list-by-tags' %}">Tags / Projects</a></li>
                        <li><a href="{% url 'crm-list-tags' %}">Index des tags</a></li>
                    </ul>
                </div>
            </div>
        <div class="px-4 pt-4 bg-light crm-timeline-min-height">
            <h3 class="mt-3">
                <svg class="bi align-middle" width="24" height="24">
                    <use xlink:href="{% static 'svg/bootstrap-icons.svg' %}#lightning-fill"/>
                </svg>
                <span class="align-middle">Activité sur les différents projets</span>
            </h3>
            <ul class="list-group">
                {% for action in projects_stream|slice:":200" %}
                <li class="list-group-item">

                    <span class="text-secondary">{{ action.timestamp|naturalday|capfirst }}</span> -
                    {% if action.target %}
                    <a href="{% url 'crm-user-details' action.actor.pk %}">{{ action.actor|capfirst }}</a> <strong>{{ action.verb }}</strong> {{ action.action_object }} (sur <a href="{{ action.target.get_absolute_url }}">{{ action.target }}</a>)
                    {% else %}
                    {% if action.action_object %}
                    <a href="{% url 'crm-user-details' action.actor.pk %}">{{ action.actor|capfirst }}</a> <strong>{{ action.verb }}</strong> <a href="{{ action.action_object.get_absolute_url }}">{{ action.action_object }}</a>
                    {% else %}
                    {{ action.actor|capfirst }} <strong>{{ action.verb }}</strong>
                    {% endif %}
                    {% endif %}

                </li>
                {% empty %}
                -- Pas encore d'activité, revenez plus tard ! --
                {% endfor %}
            </ul>

            <h3 class="mt-3">
                <svg class="bi align-middle" width="24" height="24">
                    <use xlink:href="{% static 'svg/bootstrap-icons.svg' %}#people"/>
                </svg>
                <span class="align-middle">Connexions</span>
            </h3>
            {% activity_stream "model_actions" user_model %}
            <ul class="list-group">
                {% for action in stream|slice:":200" %}
                {% if action.verb == "s'est connecté" %}
                <li class="list-group-item">
                    {{ action.timestamp|naturalday|capfirst }} - <a href="{% url 'crm-user-details' action.actor.pk %}">{{ action.actor|capfirst }}</a> {{ action.verb }}
                </li>
                {% endif %}
                {% empty %}
                -- Pas encore d'activité, revenez plus tard ! --
                {% endfor %}
            </ul>

            <h3 class="mt-3 d-inline-block">
                <svg class="bi align-middle" width="24" height="24">
                    <use xlink:href="{% static 'svg/bootstrap-icons.svg' %}#journal-check"/>
                </svg>
                <span class="align-middle">Mes dernières actions</span>
            </h3>
            <ul class="list-group">
                {% for task in request.user.tasks_created.all|slice:":200" %}
                <li class="list-group-item"><a href="{{ task.get_absolute_url }}">{{ task }}</a> ({{ task.project }})</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
{% endblock %}
