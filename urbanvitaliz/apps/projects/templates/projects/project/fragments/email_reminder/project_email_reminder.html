{% load django_vite %}
{% block js %}
    {% vite_asset 'js/apps/projectEmailReminder.js' %}
{% endblock %}
{% load static %}
<div x-data="ProjectEmailReminder()" class="d-flex flex-row-reverse">
    {% if request.user in project.members.all or position.is_advisor or position.is_observer %}
        <button x-ref="emailReminderButton"
                @click="onEmailReminderButtonClick"
                data-bs-toggle="tooltip"
                data-bs-title="Email de rappel"
                data-test-id="button-open-reminder-settings"
                class="btn btn-outline-primary btn-sm pt-1 px-2 pb-2">
            <svg class="bi align-middle" width="18" height="18" fill="currentColor">
                <use xlink:href="{% static 'svg/bootstrap-icons.svg'  %}#bell" />
            </svg>
        </button>
        <div x-cloak
             x-ref="emailReminderTooltip"
             @click.outside="onOutsideEmailReminderButtonClick"
             data-test-id="tooltip-reminder-settings"
             class="bg-white email-reminder-popup border medium-border-radius border-blue box-shadow-popup">
            <div class="d-flex align-items-center justify-content-between border-bottom-grey p-2">
                <span class="tiny fw-medium">Paramètres de notification</span>
                <button class="appearance-none bg-white"
                        aria-label="Fermer la popupde rappel"
                        data-test-id="button-close-reminder-settings"
                        @click="onOutsideEmailReminderButtonClick">
                    <svg class="bi align-middle" width="18" height="18" fill="currentColor">
                        <use xlink:href="{% static 'svg/bootstrap-icons.svg'  %}#x" />
                    </svg>
                </button>
            </div>
            {% if request.user == project.owner %}
                <div class="border-bottom-grey p-2 d-flex flex-column"
                     data-test-id="message-reminder-settings">
                    <span class="tiny fw-medium">Rappels</span>
                    <span class="tiny fw-normal mb-2">Vous recevez un rappel par email toutes les 6 à 12 semaines pour consulter et mettre à jour votre avancement sur les recommandations.</span>
                    {% if project.next_reminder %}
                        {% with project.next_reminder as reminder %}
                            <span class="tiny fw-medium text-blue">Prochain rappel prévu le {{ reminder.deadline|default:"Aucun" }} ({{ reminder.get_kind_display }})</span>
                        {% endwith %}
                    {% else %}
                        <span class="tiny fw-medium text-blue">Aucun rappel prévu</span>
                    {% endif %}
                </div>
            {% endif %}
            <div class="border-bottom-grey p-2 d-flex flex-column">
                <span class="tiny fw-medium">Activité du projet</span>
                <span class="tiny fw-normal mb-2">Vous recevez une notification par email à chaque nouvelle activité sur le projet dans un récapitulatif journalier.</span>
            </div>
            <div class="border-bottom-grey p-2 d-flex flex-column"
                 data-test-id="reminder-settings-access">
                {% if request.user == project.owner %}
                    <span class="tiny fw-normal mb-1">Pour couper les notifications vous pouvez mettre le projet en pause <a href="{% url 'projects-project-administration' project.pk %}#project-status-settings">dans l’adminstration</a></span>
                {% else %}
                    <span class="tiny fw-normal mb-1">Si vous ne souhaitez plus recevoir de notifications vous pouvez quitter le projet <a href="{% url 'projects-project-administration' project.pk %}#project-status-settings">dans l’adminstration</a></span>
                {% endif %}
            </div>
        </div>
    {% endif %}
    <div class="d-flex align-items-center">
        {% if project.next_reminder %}
            {% with project.next_reminder as reminder %}
                <span class="tiny me-2">Le prochain rappel sera envoyé à <strong class="fw-medium" data-test-id="email-recipient">{{ project.owner }}</strong> le  <span data-test-id="email-date">{{ reminder.deadline|default:"Aucun" }}</span></span>
            {% endwith %}
        {% else %}
            <span class="tiny fw-medium me-2" data-test-id="no-reminders">Aucun rappel prévu</span>
        {% endif %}
    </div>
</div>
