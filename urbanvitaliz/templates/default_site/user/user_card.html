{% load gravatar %}
{% load static %}
{% load django_vite %}

{% block js %}
    {% vite_asset 'js/apps/user.js' %}
{% endblock %}

{% load guardian_tags %}

{% get_obj_perms request.user for request.site as "user_site_perms" %}
{% get_obj_perms request.user for project as "user_project_perms" %}

<div x-data="User()" class="user-card position-relative d-flex my-1 flex-column justify-content-between align-items-start">
    <div x-ref="user" @click="onUserClick" class="d-flex align-items-center justify-content-between {% if user_activity %} w-100 {% endif %}">
        <div class="d-flex align-items-center flex-wrap">
            <span class="me-1 d-flex align-items-center font-very-small">
                <img class="rounded-circle me-1" src="{% gravatar_url user.email size=18 %}" alt="{{action.actor}}">
                <strong class="text-nowrap text-capitalize">
                    {% if user.get_full_name %}
                        {{ user.get_full_name }}
                    {% elif project and project.first_name and project.last_name %}
                        {{ project.first_name }}
                        {{ project.last_name }}
                    {% else %}
                        {{user.email}}
                    {% endif %}
                </strong>
            </span>
            <span class="text-dark fw-normal font-italic font-very-small">{{user.profile.organization.name}}</span>
        </div>
        {% if 'use_crm' in user_site_perms and user_activity %}
            <a class="small" href="{% url 'crm-user-details' user.pk %}">
                <svg class="bi me-1" width="16" height="16" fill="currentColor">
                    <use xlink:href="{% static 'svg/bootstrap-icons.svg' %}#activity" />
                </svg>
            </a>
        {% endif %}
    </div>
    {% if user_hover %}
        <div x-cloak x-ref="userTooltip" id="user-tooltip" @click.outside="onOutsideUserClick" class="user-card-popup flex-column">
            <div class="user-role position-absolute">
                <span class="py-1 px-2 fw-bold text-uppercase tiny bg-green-dark text-white"
                    style="border-radius: 2px;">Conseiller</span>
            </div>
            <div class="d-flex align-items-center flex-wrap">
                <span class="me-2 d-flex align-items-center font-very-small">
                    <img class="rounded-circle me-2" src="{% gravatar_url user.email size=18 %}" alt="{{action.actor}}">
                    <strong class="text-nowrap text-capitalize">
                        {% if user.get_full_name %}
                            {{ user.get_full_name }}
                        {% else %}
                            {{user.email}}
                        {% endif %}
                    </strong>
                </span>
                <span class="text-grey-dark fw-light font-italic font-very-small">{{user.profile.organization.name}}</span>
            </div>
            <span class="d-flex align-items-center text-blue font-very-small mt-1">
                <svg class="bi align-middle me-2" width="18" height="18" fill="currentColor">
                    <use xlink:href="{% static 'svg/bootstrap-icons.svg'  %}#link-45deg" />
                </svg>
                    <a class="text-decoration-none text-blue" href="mailto:{{ user.email }}">{{ user.email }}</a>
            </span>
            {% if user.profile.phone_no %}
                <span class="d-flex align-items-center text-blue font-very-small mt-1">
                    <svg class="bi align-middle me-2" width="15" height="15" fill="currentColor">
                        <use xlink:href="{% static 'svg/bootstrap-icons.svg'  %}#telephone" />
                    </svg>
                    <a class="text-decoration-none text-blue" href="tel:{{ project.owner.profile.phone_no }}">{{ user.profile.phone_no }}</a>
                </span>
            {% endif %}
        </div>
    {% endif %}
</div>
